= Configuring CPU-based Horizontal Pod Autoscaling (HPA) for CH2 Deployments
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

You can configure horizontal scaling of Mule applications to make them responsive to CPU usage by automatically scaling up or down the deployment replicas as needed.

In Kubernetes, a Horizontal Pod Autoscaler (HPA) automatically updates a workload resource, with the aim of automatically scaling the workload to match demand. Horizontal scaling means that the response to increased load is to deploy more pods. For more information, visit the https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale[Kubernetes documentaton^]. 

== Configure Horizontal Autoscaling

To configure horizontal autoscaling:

. From Anypoint Platform, select *Runtime Manager* > *Applications*.
. Click *Deploy application*.
. In the *Runtime* tab, check the *Enable Autoscaling* box.
. Set the minimum and maximum *Replica Count* limits.
. Click *Deploy Application*.

image::ch2-config-autoscaling.png[Configure horizontal autoscaling.]


== Performance Considerations and Limitations

* CPU-based HPA does not work with clustering and rate limiting.
* CPU-based HPA works with 0.1 vCcores replica size only.
* CPU-based HPA is specially useful for Mule applications that scale based on CPU usage. For example, HTTP/HTTPS applications with async requests, or  Mule applications with high throughput (shorter requests, lower latency).


== Autoscaling Status and Logs

When an autoscaling event occurs and your Mule application with horizontal autoscaling scales up, you can check the *Scaling* status by clicking *View status* in your application's details window. You can also see the *Scaling* status of your application in the *Applications* list.

image::ch2-status-autoscaling.png[Check the application's scaling status.]


You can track the scaled-up replicas startup and the number of replicas your application scaled from and to by checking the application's logs:

. From Anypoint Platform, select *Runtime Manager* > *Applications*.
. Click the row of the application with autoscaling.
. Click *Manage application*.
. Select the *Logs* tab.

[source,console,linenums]
----
Info	8 minutes ago - 2023-11-08 14:35:01.466 PST - Runtime Manager
Application id:<app-ID> scaled UP from 1 to 2 replicas.
Info	a minute ago - 2023-11-08 14:41:24.819 PST - Runtime Manager
Application id:<app-ID> scaled DOWN from 2 to 1 replicas. :
----

== CPU-based Autoscaling Policy

MuleSoft owns and applies the https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/[autoscaling^] policy for your Mule application deployments.

The CPU based HPA policy used for all Mule apps deployed to CloudHub 2.0 is as follows:

----
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: my-app
  namespace: app-namespace
spec:
  behavior:
    scaleDown:
      policies:
      - periodSeconds: 15
        type: Percent
        value: 100
      selectPolicy: Max
      stabilizationWindowSeconds: 300
    scaleUp:
      policies:
      - periodSeconds: 180
        type: Percent
        value: 100
      selectPolicy: Max
      stabilizationWindowSeconds: 0
  maxReplicas: 3
  metrics:
  - resource:
      name: cpu
      target:
        averageUtilization: 70
        type: Utilization
    type: Resource
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: my-app
----

Some points to consider:

Scale up +

* Each period up to 100% of the running pods may be added until the maximum configured replicas.
* The number of replicas added is based on the aggregated calculations over the past 180 seconds.
* Max scale up profile is 1 -> 2 -> 4 -> 8, where MuleSoft hits 8 replicas in approximately 6 minutes.

Scale down +

* Each period, running replicas may be scaled down till it reaches the minimum configured replicas.
* The number of replicas removed is based on the aggregated calculations over the past 300 seconds of the stabilization window.


== See Also

* xref:runtime-fabric::configure-horizontal-autoscaling.adoc[]
