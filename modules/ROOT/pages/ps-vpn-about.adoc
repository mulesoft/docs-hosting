= Anypoint Virtual Private Network 

*Last update* 28-Feb-22


Anypoint VPN (virtual private network) creates a secure connection between your private space and your on-premises network.

Anypoint VPN enables apps running in the private space
to access resources in your on-premises data centers behind your corporate firewall.
The VPN connection comprises two VPN tunnels between the private space in Anypoint Platform and a _gateway device_, a physical or software appliance located in your network.

You use an IPsec tunnel with network-to-network configuration to connect your on-premises data centers to your private space.

An IPsec VPN tunnel is generally the recommended solution for private space to on-premises connectivity, as it provides a standardized, secure way to connect.
This method also integrates well with existing IT infrastructure such as routers and appliances. 

image::ps-overview-ipsec.png[IPsec Tunnel Overview]

To create an Anypoint VPN connection to your network, see xref:ps-create-configure.adoc#create-connection-to-external-network[Create a Connection to an External Network].

You can create multiple site-to-site VPNs if required. 

[NOTE]
The number of VPNs you can create depends on the network connection entitlements available to your account.
Contact your MuleSoft account representative if you don't know how many network connection entitlements you have on your account. 

Anypoint VPN supports site-to-site Internet Protocol security (IPsec) connections.
A physical or software appliance, called a VPN endpoint, is the terminator on your side of the connection.
The Anypoint side of the connection is an implementation of a virtual private gateway (VGW).
The MuleSoft VGW is associated with a single private space but can support up to 10 VPN connections. 

[[vpn-features]]
== Anypoint VPN Features

Each Anypoint VPN connection consists of two tunnels that enable you to connect to a single public IP address at a remote location. To configure connectivity to an additional public IP address at a remote location, you must create two VPN connections.

A single VPN provides increased availability for your private space. Routine maintenance can briefly disable one of the two tunnels of your VPN connection. During this time, your VPN connection automatically fails over to the second tunnel so access is not interrupted. For this reason, both tunnels must be configured on your endpoint. Tunnel selection depends on your VPN endpoint capabilities and the routing type selection. 
 
The MuleSoft VGW implementation supports a maximum throughput of 1.25 Gbps. Multiple VPN connections to the same private space share the throughput capabilities of a single VGW. The VPN connection throughput depends on several factors, such as the capability of your VPN endpoint, the capacity of the connection, the average packet size, the protocol, and network latency between the gateways.

[[vpn-ipsec]]
== IPsec Settings

Anypoint VPN supports any combination of the following IPsec settings:

* IKE version 1
* IKE version 2 for route-based VPNs only
* AES 128 or 256-bit encryption operating in the Chain Block Cipher (CBC) mode
* SHA or SHA-2 (256) hashing
* Diffie-Hellman Phase1 groups 2, 14-18, 22, 23, 24
* Diffie-Hellman Phase2 groups 2, 5, 14-18, 22, 23, 24
* IKE (Phase 1) Lifetime: 28000 seconds (7 hours and 50 minutes)
* IPsec (Phase 2) Lifetime: 3000 seconds (50 minutes)

[NOTE]
Your endpoint must initiate traffic to establish and maintain the connection because the Anypoint VPN endpoint acts only as a responder.

[[vpn-routing]]
== Anypoint VPN Routing

Anypoint VPN supports dynamic or static routing for VPN connections.

Dynamic routing::
Your device uses Border Gateway Protocol (BGP) to advertise routes to Anypoint VPN. Use BGP routing if your device supports this protocol.
Static routing::
Requires you to specify the routes (subnets) in your network that are accessible through Anypoint VPN.
+
You can remove routes for static VPN connections. 

[NOTE]
A maximum of 95 route table entries is permitted per private space, regardless of the number of VPN connections.
Consolidate networks to the fewest number possible to avoid exceeding the limit.  

You can't add a route that matches a priority route (a route that's used by your private network).

Routes can be used by only one connection at a time.
If you enter a non-local/Internet Gateway (IGW) route to a route table, CloudHub 2.0 warns that the route is being used by another connection.

Routes should not overlap with existing routes.
CloudHub 2.0 warns if you enter a route that overlaps with another route in the route table.


[[vpn-limitations]]
== Anypoint VPN Limitations

Anypoint VPN does not support these features and configurations:

* Network Address Translation (NAT)
* IPv6
* IKEv2 with policy-based VPNs
* A single private space with both Direct Connect and Anypoint VPN connections
* Advertising a default route (0.0.0.0/0) over BGP or static routing

[[vpn-recommendations]]
== Anypoint VPN Recommendations

* Adjust the maximum segment size of TCP packets entering the VPN tunnel.
+
VPN headers require additional space, which reduces the amount of space available for data.
+
To limit the impact of this behavior, configure your endpoint with TCP MSS Adjustment: 1387 bytes.
* Reset the `DF` flag on packets.
+
Packets might carry a Don't Fragment (`DF`) flag, indicating that the packet must not be fragmented. Some VPN devices can override the `DF` flag and fragment packets unconditionally when required. If available, enable the setting `Clear Don't Fragment (DF) Bit`.

[[vpn-ha]]
== VPN High Availability

Set up a redundant VPN connection to prevent losing connectivity if another 
VPN or connection device is not available and to allow for maintenance downtime.

The redundant VPN inherits some settings from the initial VPN configuration automatically.
For example, if the routing type for the initial VPN is dynamic (BGP), the redundant
VPN is also dynamic.

Other settings, such as the remote ASN for dynamic routing, for the redundant VPN include the values from the initial VPN,
but you can change the values.

////

https://docs.aws.amazon.com/vpn/latest/s2svpn/vpn-redundant-connection.html

risks of having a VPN that’s not highly available, potential causes, and recommendations on how to address it. We can assume in this case that their VPN uses static routing, so it’s possible that this is intended behavior.


Q: Why would someone choose custom tunnel configuration instead of automatic?
A: BGP is recommended but not supported by all customer gateways.
A: Mainly to provide their own secrets (Xuan), but also set the PTP CIDRs for network interfaces for their own router (less common) (Henry)
Q: If the customer only has one VPN gateway, is there a reason to allow creating two VPNs? What do people do in CloudHub today?
A: Each customer gateway will only support a single VPN.
Q: Today in CloudHub, there are cases where we want to update VPNs to a new version, but there’s not a way in the UI for the customer to initiate an update. Do we want to add this functionality for private spaces? Why can’t we update VPNs automatically?
A: Waiting for responses from AWS to check the frequency of the VPN upgrade. We don’t have to do it for GA. But eventually, we need to have a button/API to upgrade VPN. (Xuan)
Q: Is it possible for static routes inputted by the user to somehow conflict with existing routes for the VPC?
A: Yes, it’s possible. I can create two VPNs with conflicting static routes. They can coexists. How it works? It’s the responsibility on the customer’s configuration. (Xuan)
Q: How should the guidance in these knowledge base articles inform our UI?
How to Configure High Availability with Anypoint VPN
This doc recommends configuring customer VPN Gateways to prefer VPN-1 Tunnel-1, then VPN-1 Tunnel-2, then VPN-2 Tunnel-1, then VPN-2 Tunnel-2, using BGP routing.
Anypoint VPN Path Selection Using BGP Routing
This doc explains the BGP best path selection algorithm.
A: This is information for Network Engineers mostly, so they will know how the Anypoint VPN behaves (meaning how the AWS VPN behaves) (Henry)
Q: Considering the above, since our downloadable guides (see example) aren’t aware of whether the VPN is part of a redundant system, how do we direct network admins to configure gateways/tunnels properly?
A: Whether a VPN is redundant doesn’t affect the connection process, so we don’t need to change the contents of the connection guides.



////

=== How VPN Failover Works

*NEED SOME INFORMATION FOR THIS SECTION*

Failover to a redundant VPN depends on the routing type:

* Dynamic (BGP)
* Static


=== VPN and Tunnel Status

New VPN connections that you create appear in the *Connections* section of the private space.
Initially, both VPN tunnels display DOWN while the infrastructure is created.

Depending on your configuration, tunnels might report a status of DOWN during normal operations.


[%header%autowidth.spread]
|===
|Status |Tunnel 1/2 |Description
|`Pending` |`DOWN/DOWN` |The VPN connection is recently created, and actions are pending in the background.

You might see this status for 10-15 minutes after creating a VPN.
|`Available` |`DOWN/DOWN` |The VPN connection is created, but the remote side is not configured or is not sending traffic.
|`Available` |`Up/Up` or `Up/Down` |The VPN connection is created, and the remote side established the connection successfully.

Tunnels operate in active/active or active/passive mode, depending on the routing configuration and your VPN device type. 
|`Failed` |`DOWN/DOWN` | The VPN connection is not created.

Delete the VPN and try again. If this failure recurs, contact MuleSoft Support.
|===




== See Also

* xref:ps-create-configure.adoc[]
* xref:ps-gather-setup-info.adoc#private-network-region[Private Network Region]
* xref:ps-config-fw-rules.adoc[]
* xref:ps-gather-setup-info.adoc#dynamic-vpn-routing[Dynamic VPN Connection Requirements]
* xref:ps-gather-setup-info.adoc#static-vpn-routing[Static VPN Connection Requirements]
* xref:ps-gather-setup-info.adoc#supported-gateway-devices[Supported Gateway Devices]
