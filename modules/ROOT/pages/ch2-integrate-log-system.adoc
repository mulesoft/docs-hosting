= Integrating with Your Logging System Using Log4j

*THIS IS BASED ON CH 1.0 CONTENT* 

*Last update* 07-Apr-22

You can integrate your CloudHub 2.0 application with your logging system by using the Log4j configuration.
After you configure logs to flow to your log system and CloudHub 2.0, disable the default CloudHub 2.0 application logs.


== Requirements and Restrictions

*PLEASE REVIEW FOR ACCURACY IN CH2*

* MuleSoft Support doesn't provide assistance for implementing custom logging configurations or resolving issues caused by custom logging configurations.
* MuleSoft is not responsible for issues arising from misconfiguration of your Log4j appender, including these or other issues:
** Lost logging data
** Performance degradation
** Running out of disk space
* Do not use synchronous log appenders.
+
You can use only asynchronous log appenders.
* When you disable application logs in CloudHub 2.0:
** Only the system logs are available in Runtime Manager.
+
System logs provide the status of your worker deployment and whether your application started correctly, but do not provide application logs.
For application worker logs, check the logging system for your application.
+
** You cannot download application worker logs from the *Logs* page for the application.
** CloudHub 2.0 warns you that logs are not available.
* You cannot forward system logs (`mule_ee.log`) to external logging solutions the same way as application logs.


== Create Your Log4j Configuration

For logs to both flow to your logging system and be viewable in CloudHub 2.0, configure the CloudHub 2.0 Log4j appender.

You can use any Log4j appender.
For information about configuring `log4j2.xml`, see the
https://logging.apache.org/log4j/2.x/manual/configuration.html#ConfigurationSyntax[Log4j Configuration Syntax^] (link out from Beta docs).

To enable the Log4j appender, update the `log4j2.xml` configuration file with your logger settings and include the Log4j appenders `Log4J2CloudhubLogAppender` and `RollingFile`.
In Anypoint Studio, the `log4j2.xml` file is located in the `src/main/resources` directory.

The two example Log4j appenders in the `log4j2.xml` file are:

Log4J2CloudhubLogAppender::
Sends log data to CloudHub 2.0.
RollingFile::
Sends log data to the filesystem of the VM.

[WARNING]
You must include the appenders in your custom configurations in the `log4j2.xml` file to enable MuleSoft Support team visibility into the logs.

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="INFO" name="cloudhub" packages="com.mulesoft.ch.logging.appender">
    <Appenders>
        <RollingFile name="FILE"
                     fileName="/opt/mule/mule-CURRENT/logs/mule-${sys:domain}.log"
                     filePattern="/opt/mule/mule-CURRENT/logs/mule-${sys:domain}-%i.log">

            <PatternLayout pattern="[%d{MM-dd HH:mm:ss.SSS}] %-5p %c{1} [%t]: %m%n"/>
            <DefaultRolloverStrategy max="10"/>
            <Policies>
                <SizeBasedTriggeringPolicy size="10 MB" />
            </Policies>
        </RollingFile>
        <Log4J2CloudhubLogAppender name="CLOUDHUB"
                addressProvider="com.mulesoft.ch.logging.DefaultAggregatorAddressProvider"
                applicationContext="com.mulesoft.ch.logging.DefaultApplicationContext"
                appendRetryIntervalMs="${sys:logging.appendRetryInterval}"
                appendMaxAttempts="${sys:logging.appendMaxAttempts}"
                batchSendIntervalMs="${sys:logging.batchSendInterval}"
                batchMaxRecords="${sys:logging.batchMaxRecords}"
                memBufferMaxSize="${sys:logging.memBufferMaxSize}"
                journalMaxWriteBatchSize="${sys:logging.journalMaxBatchSize}"
                journalMaxFileSize="${sys:logging.journalMaxFileSize}"
                clientMaxPacketSize="${sys:logging.clientMaxPacketSize}"
                clientConnectTimeoutMs="${sys:logging.clientConnectTimeout}"
                clientSocketTimeoutMs="${sys:logging.clientSocketTimeout}"
                serverAddressPollIntervalMs="${sys:logging.serverAddressPollInterval}"
                serverHeartbeatSendIntervalMs="${sys:logging.serverHeartbeatSendIntervalMs}"
                statisticsPrintIntervalMs="${sys:logging.statisticsPrintIntervalMs}">

            <PatternLayout pattern="[%d{MM-dd HH:mm:ss}] %-5p %c{1} [%t]: %m%n"/>
        </Log4J2CloudhubLogAppender>
    </Appenders>
    <Loggers>
        <AsyncRoot level="INFO">
            <AppenderRef ref="FILE"/>
            <AppenderRef ref="CLOUDHUB"/>
        </AsyncRoot>
        <AsyncLogger name="com.gigaspaces" level="ERROR"/>
        <AsyncLogger name="com.j_spaces" level="ERROR"/>
        <AsyncLogger name="com.sun.jini" level="ERROR"/>
        <AsyncLogger name="net.jini" level="ERROR"/>
        <AsyncLogger name="org.apache" level="WARN"/>
        <AsyncLogger name="org.apache.cxf" level="WARN"/>
        <AsyncLogger name="org.springframework.beans.factory" level="WARN"/>
        <AsyncLogger name="org.mule" level="INFO"/>
        <AsyncLogger name="com.mulesoft" level="INFO"/>
        <AsyncLogger name="org.jetel" level="WARN"/>
        <AsyncLogger name="Tracking" level="WARN"/>
    </Loggers>
</Configuration>
----

== Enable a Custom Log4j Configuration for an Application

After you configure the Log4j appender, follow these steps to deploy the application to CloudHub 2.0 and disable application logs:

. When deploying an app, click the *Logging* tab.
+
If the app is already deployed:
+
--
include::partial$select-private-space.adoc[tag=selectAppsPage]
include::partial$select-private-space.adoc[tag=clickAppName]
include::partial$select-private-space.adoc[tag=clickSettings]
. Click the *Logging* tab.
--
. Deselect *Enable application logs and metrics*:
+
<screenshot>
+
// image::cloudhub-disable-logs.png[Disable CloudHub 2.0 logs option in the Applications Settings page]

. Depending on the deployment status, choose either:
** If you're ready to deploy the application, click *Deploy*.
** If this application is deployed, click *Apply Changes*.

After your application starts, logs start flowing to your custom Log4j appender and are viewable on your target logging system.

== See Also

* xref::ch2-deploy-private-space.adoc[]
* xref::ch2-deploy-shared-space.adoc[]

